<!doctype html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang=""> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8" lang=""> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9" lang=""> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang=""> <!--<![endif]-->
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Q_RUMBITS</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <link rel="icon" href="apple-touch-icon.png">
    <link rel="stylesheet" href="css/bootstrap.css">
    <style>
      body {
          padding-top: 50px;
          padding-bottom: 20px;
      }
    </style>
    <!--<link rel="stylesheet" href="css/bootstrap-theme.min.css">-->
    <link rel="stylesheet" href="css/main.css">
    <script src="js/vendor/jquery-1.11.2.js" type="text/javascript"></script>
    <!--<script src="js/vendor/jquery-3.1.1.js" type="text/javascript"></script>-->
    <!--<script src="js/vendor/modernizr-2.8.3-respond-1.4.2.min.js"></script>-->
  </head>
  <body>
    <!--[if lt IE 8]>
    <p class="browserupgrade">You are using an <strong>outdated</strong>
        browser. Please <a href="http://browsehappy.com/">upgrade your browser</a>
        to improve your experience.</p>
    <![endif]-->
    <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse"
                  data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">Q_rumBits 	&#62;&#62; my project </a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <form class="navbar-form navbar-right" role="form">
            <div class="form-group">
              <input type="submit" class="btn btn-success" onclick="pid0()"
                     value="X">
            </div>
            <div class="form-group">
              <input type="submit" class="btn btn-warning" onclick="lg0()"
                     value="logout">
            </div>
            <button type="submit" onclick="app.delete()" class="btn btn-danger">
              complete reset</button>
          </form>
        </div><!--/.navbar-collapse -->
      </div>
    </nav>
    <div class="container" id="Login">
      <p></p>
      <div class="container-fluid " id="lg">
        <div class="col-sm-4 well col-sm-offset-4 form-group-lg">

          <label class="text-center jumbotron form-control well nbrdr ">Login</label>
          <input id="signemail" type="email" class="form-control" title="enter email here" placeholder="Email">
          <input id="signpass" type="password"  class="form-control" oninput="verify()"
                 data-placement="left" title="enter password here" placeholder="Password">
          <!--<div class="tooltip" role="tooltip" id="passe">password cant not be empty</div>-->
          <button class="form-control btn btn-info" onclick="sign_in()">Sign in or Register</button>

        </div>
      </div>
      <div class="container-fluid hidden" id="rg">
        <div class="col-sm-4 well col-sm-offset-4">
          <div class="form-group-lg">
            <label class="jumbotron text-center form-control">Register</label>
            <input id="email" type="email" class="form-control" placeholder="Email">
            <input id="username" type="text" class="form-control" placeholder="Username">
            <select id="rrole" class="form-control">
              <option value="t">User</option>
              <option value="m">Manager</option>
            </select>
            <input id="pass" oninput="verify()" data-placement="left" type="password" class="form-control" placeholder="Password">
            <input id="conpass" oninput="verify()" data-placement="left" type="password" class="form-control" placeholder="Confirm Password">
            <button id="reg" class="btn btn-info " disabled="" onclick="sendR()"  >Register</button>
          </div>
        </div>
      </div>
    </div>
    <div class="container hidden" id="landing">
      <p class=""></p> <h3>Welcome </h3>


    </div><div class=" modal " id="mnu" style="margin-top: 4em">

      <div class="modal-content modal-dialog modal-sm form-group" >
        <div class="modal-header"><button id="e" class="close"
                                          data-dismiss="modal">x</button></div><div class="form-group-sm">
          <!--            <label class="modal-title form-control text-center text-capitalize">
                         New Proj</label>-->
          <div class="form-group">
            <button class="btn btn-info form-control">Blank</button>
          </div><div class="form-group">
            <button class="btn btn-success form-control" onclick="create()">Default</button>
          </div><div class="form-group">
            <button class="btn btn-info form-control">Templates</button>
          </div>
        </div>
      </div>
    </div>
    <p class="divider"></p>
    <div class="container" id="proj">

    </div>
    <hr>

    <footer>
      <p class="text-center"> Q_rumBits  Q LINK  &copy;2017</p>
    </footer>
    <!--</div>  /container         <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.js"></script>-->
    <!--<script src="../../../Downloads/jquery-3.1.1.js" type="text/javascript"></script>-->
    <!--<script>window.jQuery || document.write('<script src="js/vendor/jquery-1.11.2.js"><\/script>')</script>-->\
    <script>if (localStorage.hasOwnProperty("pid") && localStorage.hasOwnProperty("usr"))
            $("#login").addClass("hidden");</script>
    <!--<script>window.jQuery || document.write('<script src="js/vendor/jquery-1.11.2.js"><\/script>')</script>-->
    <script> if (!window.hasOwnProperty('openDatabase'))
            nop;</script>
    <script src="js/vendor/bootstrap.min.js"></script>
    <script src="js/custom/Q_ueryBuild.js" type="text/javascript"></script> 
    <script src="js/custom/app.js" type="text/javascript"></script>

    <script src="js/custom/UILoad.js" type="text/javascript"></script>
    <script src="js/main.js"></script>

    <!-- Google Analytics: change UA-XXXXX-X to be your site's ID. -->
    <script>
      //            (function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
      //            function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
      //            e=o.createElement(i);r=o.getElementsByTagName(i)[0];
      //            e.src='//www.google-analytics.com/analytics.js';
      //            r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
      //            ga('create','UA-XXXXX-X','auto');ga('send','pageview');
      var lg = false;
      var qb = app.qb;
      var db = qb.db;
      var co;
      var res = "";
      var usr = localStorage.getItem('usr') || 0;
      var c = localStorage.getItem('c') || 0;
      var trs = [0, 0, 0];
      $('[data-toggle="tooltip"]').tooltip();
      UILoad.pid = localStorage.getItem('pid') || -100;
      //console.log(pid);
      //if (pid == -100) {
      function sign_in() {
        var t = $('#signemail');
        if (t.val().trim() === "") {//changed from == to ===

          message("cant be empty", $('#signemail'));
        } else {
          lg = true;
          v_email();
        }
      }

      if (window.hasOwnProperty('openDatabase')) {


        function message(msg, t) {
          //alert(msg);

          //$('[data-toggle="tooltip"]').tooltip();
          t.tooltip("destroy");

          t.prop("title", msg);
          t.tooltip("show");
        }
        function v_email() {//testemail
          var email1 =
                  $('#signemail').val();//input box value
          var pass = $("#signpass").val();
          var tst = /.+[@].+[\.].+/; //create regex
          if (tst.test(email1))
          {
            $.post("php/data_verify.php",
                    {email: email1, password: pass}, function (response) {
              if (response.userstatus === 1) {
                localStorage.setItem('usr', response.c);
                UILoad.pid = localStorage.pid;
                loda();
                app.app();
                //app.list();
              } else if (response.userstatus === -1) {
                rg(email1);
              } else {
                
                if (localStorage.count === undefined ||
                  parseInt(localStorage.getItem("count")) < 3){
                  message('invalid password', $('#signpass'));
                  localStorage.setItem("count",parseInt(localStorage.getItem("count")) + 1 || 0);
                }
                else
                  message('email sent to reset password', $('#signpass'));
                }
            }
            , 'JSON');//AJAX post (JQUERY Function)
          } else if (!tst.test(email1)) {
            message('invalid email', $('#signemail'));
          } else {
            
          }
        }
        function verify() {//password test
          var tgt = $("#signpass");
          var tgt1 = $("#pass").val();
          var tgt2 = $("#conpass").val();

          var pwd = tgt.val();
          var tst = /(?=.*[0-9])(?=.*[a-z])(?=.*[A-Z])(?=.*[\u0020-\u002F|\u003A-\u0040|\u005B-\u0060|\u007B-\u007E])/;
          if (tst.test(pwd)) {
            if (trs[0] === 0)
              $("#signpass").tooltip("destroy");
            trs[0] = 1;
          } else if (pwd.length < 8)
            message("Password too short", $("#signpass"));
          if (tgt1.length < 8) {
            message("weak password", $("#pass"));
            $()
          } else if (tst.test(tgt1)) {
            if (trs[1] === 0)
              $("#pass").tooltip("destroy");
            trs[1] = 1;
          } else if (!tst.test(tgt1)) {
            trs[1] = 0;
          }
          if (tgt1 == tgt2 && trs[1] == 1) {
            if (trs[2] === 0)
              $("#conpass").tooltip("destroy");
            trs[2] = 1;
            console.log("passmatch");
            message("Okay", $("#conpass"));
          } else {
            message("Password does match", $("#conpass"));
            trs[2] = 0;
          }
          if (trs[2] === 1)
            $("#reg").prop("disabled", false);
        }
        function rg(email1) {
          var targ = $("#rg");
          targ.removeClass("hidden");
          $("#email").val(email1);
          var test = /@.+/;
          $('#username').val(email1.replace(test, ""));
          $("#lg").addClass("hidden");
          message("Error: email is not registered " +
                  "please fill the information below", targ);
        }
        function sendR() {
          var eml = $("#email").val().trim();
          var usrn = $("#username").val().trim();
          var pswd = $("#pass").val().trim();
          var rl = $("#rrole").val().trim();

          $.post("php/data_verify.php"
                  , {email: eml, pwd: pswd, role: rl, username: usrn},
                  function (respo) {
                    var resp = JSON.parse(respo);
                    console.log(resp);
                    if (resp.userstatus === 1) {//needs improving
                      console.log("attempt to load");
                      localStorage.setItem("usr", resp.c);
                      localStorage.setItem("pid", 0);
                      loda();
                      app.app();
                    } else {
                      console.log(resp);
                    }
                  }
          , "TEXT");

        }
        $(document).ready(function () {
          qb.init();
          db.transaction(function (tx) {
            var qry = qb.slct('count(*) as c', 'taskbars');
            tx.executeSql(qry, [], function (tx, rs) {
              if (rs.rows.length > 0)
                c = rs.rows.item(0).c;
              localStorage.setItem('c', c);
              if (c == 0 || c == undefined) {
                db.transaction(function (tx) {
                  tx.executeSql(qb.insert("taskbars",
                          ['tid', 'pid', 'tname', 'pos'],
                          [1, 1, '"' + 'todo' + '"', 0]));
                  tx.executeSql(qb.insert("taskbars",
                          ['tid', 'pid', 'tname', 'pos'],
                          [2, 1, '"' + 'in-progress' + '"', 1]));
                  tx.executeSql(qb.insert("taskbars",
                          ['tid', 'pid', 'tname', 'pos'],
                          [3, 1, '"' + 'done' + '"', 2]));
                }, function (err) {
                  console.log(err);
                });
              }
            });
          }, function (err) {
            console.log(err);
          });
//          setTimeout(function () {
//            //console.log(c);
//            
//          }, app.qt);

          $.post("php/get_data.php",
                  {1: '1'},
                  function (resp) {
                    if (resp.hasOwnProperty('c')&& resp.c != null) {
                      if (resp.userstatus === 1)
                       
                      localStorage.setItem('usr', resp.c);
                      if (usr > 0) {
                        localStorage.pid = 0;
                        console.log("Setting Up", localStorage);
                        loda();
                        setTimeout(function () {
                          app.app();
                        }, app.qt);
                      }
                    } else {
                      localStorage.setItem("usr",0);
                    }
                    

                  }
          , "JSON");
          
          //setTimeout(function () {          // },app.qt);
        });//setup


        function projSelected(ts) {
          //alert('proj id='+($(ts).attr('id').split('_')[1] -1));
          UILoad.pid = ($(ts).attr('id').split('_')[1]);
          localStorage.setItem("pid", UILoad.pid);
          if ((UILoad.pid == 0)) {
            $('#proj').hide();
            $('#landing').show();
          } else {
            $('#proj').show();
            $('#landing').hide();
          }
          app.app();
        }
        function loda() {
          UILoad.pid = localStorage.pid;
          usr = localStorage.usr;
          $("#Login").remove();
          //$('#Login').addClass('hidden');
          $("#landing").removeClass('hidden');

        }

        function proj() {
          //alert('proj id='+($(ts).attr('id').split('_')[1] -1));
          $('#mnu').modal('show');
        }
        function create() {
          var name;

          setTimeout(function () {
            if ((name = prompt("Project Name", "please enter Projects name"))) {
              app.prototype = 1;
              app.createProj(name, usr, 1);
              setTimeout(function () {
                app.read();
              }, app.qt);
            }
          }, app.qt);
        }

        function cc(which) {
          var crd = 0;
          var q = qb.slct("cid as c", 'cards',
                  "cid  = cid order by cid desc limit 1");
                  try{
          db.transaction(function (tx) {
            tx.executeSql(q, [], function (tx, rs) {
              try{
                if (rs.rows.length > 0)
                  crd = rs.rows.item(0).c + 1;
                else
                  crd = 1;
                var parent = ($(which).parent().parent());
                console.log(parent);
                var name;
  //                    var tid = $(parent).attr("id");
  //                    var spl = tid.split("_");
  //                    tid = spl[2];
                if ((name = prompt("Create New Task"))) {
                  var l = gtid(which);
                  app.createCard(name, l, parent, crd);
                }
              }catch(ex){
                console.log(ex);
                pid0();
                window.location = ".";
              }
            });
          }, function (err) {
            console.log(err);
          });
                  }catch(ex){
                    console.log(ex);
                    pid0();
                  }


          setTimeout(function () {

          }, app.qt);//needs testing // working *i3 4th gen chrome 1.7ghz
        }
        ;
        function typ(ths) {
          //console.log($(ths).val());
          app.editCard($(ths).attr('id').toString().split('_')[3],
                  'cdesc', $(ths).val());
        }
        function allowDrop(ev) {
          ev.preventDefault();
        }
        function preventDrop(ev) {
          ev.preventDefault();
        }
        function drag(ev) {
          //console.log(ev.target.id);
          co = ev.srcElement.id;
          //console.log(co);
        }
        function drop(ev) {
          ev.preventDefault();

          //console.log(app.cards);
          if (match(ev.srcElement.id)) {
            $(ev.target).append($('#' + co));
            qb.transaction(qb.update('cards'
                    , "tid = '" + ev.srcElement.id.split('_')[2] + "'"
                    , 'cid', '"' + co.split('_')[3] + '"'));
            console.log(qb.update('cards'
                    , "tid = '" + ev.srcElement.id.split('_')[2] + "'"
                    , 'cid', '"' + co.split('_')[3] + '"'));
          }
        }
        function gtid(ths) {//get parent
          var parent = ($(ths).parent());
          while (!match(parent.attr('id')))
            parent = parent.parent();
          var tid = $(parent).attr("id");
          console.log(tid);
          var spl = tid.split("_");
          return (spl);
        }
        function adv(ths) {
          var spl = gtid(ths);
          $('#' + app.colNames[spl[2] % app.colNames.length])
                  .append($(ths).parent());
          app.editCard($(ths).parent().attr('id').toString().split('_')[3],
                  'tid', ((spl[2] % app.colNames.length) + 1));

          $('#tid_' + spl[1] + '_' + (spl[2])).remove($(ths).parent());
          console.log(spl);

        }
        function match(pnt) {
          for (var a = 0; a < app.colNames.length; a++)
            if (pnt === app.colNames[a])
              return true;
          return false;
        }
        function pid0() {
          localStorage.setItem("pid", 0);
        }
        function lg0() {
          pid0();
          UILoad.tsb = null;
          //app.delete();//wait ntil sync implementation the implement this
          $.post("php/logout.php", {}, function () {}, "HTML");
        }
      } else {
        if (!window.hasOwnProperty('openDatabase'))
          $('#proj').append("<h1 class='jumbotron'>SO SAD! You Need Google Chome \
                               or Opera Or Chromium web Browser </h1>");
      }
    </script>
  </body>
</html>
